---
layout: post
title: Node ch.15
excerpt: "[Node] local-strategy 콜백 완성 "
categories: [Node Tutorial]
comments: true
image:
  feature:
  credit: thomas shellberg
  creditlink: https://unsplash.com/photos/Ki0dpxd3LGc
---

# local-strategy 콜백 완성

## local-strategy 콜백을 완성해서 인증처리에 필요한 함수를 완성하기


1. 인증처리 코드 추가 

    /router/join/index.js
    
    ```js
    
    var express = require('express')
    var app = express()
    var router = express.Router()
    var path = require('path')
    var mysql = require('mysql')
    var passport = require('passport');
    var LocalStrategy = require('passport-local').Strategy;
    
    
    // DATABASE SETTING (Google Cloud SQL)
    var connection = mysql.createConnection({
        host     : '35.189.176.97',
        port     : 3306,
        user     : 'root',
        password : 'root',
        database : 'jsman'
    });
    
    connection.connect();
    
    
    router.get('/', function(req,res){
        //res.sendFile(path.join(__dirname, '../../public/join.html'))
        res.render('join.ejs')
    })
    
    passport.use('local-join', new LocalStrategy({
            usernameField: 'email',  //default 속성값
            passwordField: 'password', //default 속성값
            passReqToCallback: true
        }, function (req, email, password, done) {
            var query = connection.query('select * from user where email=?', [email], function(err,rows){
                if(err) return done(err);
    
                if(rows.length){
                    console.log('existed user')
                    return doen(null, false, {message : 'Your email is already used'})
                } else {
    
                }
            })
            }
    ));
    
    router.post('/', passport.authenticate('local-join', {
        successRedirect: '/main',
        failureRedirect: '/join',
        failureFlash: true })
    )
    
    
    // router.post('/', function(req,res){
    //     var body = req.body;
    //     var email = body.email;
    //     var name = body.name;
    //     var passwd = body.password;
    //
    //
    //     var sql = {email : email, name : name, password : passwd};
    //     var query = connection.query('insert into user set ?', sql, function(err, rows) {
    //         if(err) { throw err;}
    //         console.log("Data inserted!", rows.insertID, name);
    //         res.render('welcome.ejs', {'name' : name, 'id': rows.insertId})
    //
    //
    //
    //     })
    // })
    
    module.exports = router;
    
    ```
    
2. Call-back 함수 done() 
    
    http://passportjs.org/docs/overview 
    
    위 사이트에서 done 검색

3.     